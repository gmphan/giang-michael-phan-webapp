@model ProjectView
@{
    ViewData["Title"] = "Project Detail";
    var projectMain = Model;
    var tasks = Model.ProjectTasks;
    @* var activities = Model.ProjectTaskActivities; *@
}
<div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
        <h2>Project Details</h2>

        <h3>Project: @projectMain.ProjectName</h3>
        <p>Description: @projectMain.ProjectDescription</p>
        <p>Start Date: @projectMain.ProjectStartDate.ToShortDateString()</p>
        <p>Due Date: @projectMain.ProjectDueDate.ToShortDateString()</p>
 
        <h3>Tasks</h3>
        <div class="card-body">
            <!-- Task Selection Dropdown -->
            <div class="mb-3">
                <label for="taskSelect">Select Task:</label>
                <select id="taskSelect" class="form-select">
                    <option value="">---Select a Task---</option>
                    @foreach(var task in tasks)
                    {
                        <option value="@task.Id"
                            data-task-name="@task.ProjectTaskName"
                            data-task-description="@task.ProjectTaskDescription"
                            data-task-state="@task.ProjectTaskState"
                            data-start-date="@task.ProjectTaskStartDate.ToString("MM/dd/yyyy")"
                            data-due-date="@task.ProjectTaskDueDate.ToString("MM/dd/yyyy")"
                            data-completed-date="@task.ProjectTaskCompletedDate?.ToString("MM/dd/yyyy")"
                            >
                            @task.ProjectTaskName
                        </option>
                        <!-- Store task activities in a hidden script tag as a JSON object. 
                         DO NOT directly add data-activities to option above, the JSON will not work.
                        -->
                        <script id="task-activities-@task.Id" type="application/json">
                            @Html.Raw(System.Text.Json.JsonSerializer.Serialize(task.ProjectTaskActivities.Select(a => new { a.ActivityNote, CreatedDate = a.CreatedDate.ToString("MM/dd/yyyy") }).ToList()))
                        </script>
                    }
                </select>
            </div>

            <!-- Task Details and Activities -->
            <div id="taskDetails" class="mb-3" style="">
                <h4 id="taskName"></h4>
                <p id="taskDescription"></p>
                <p><strong>Task State:</strong> <span id="taskState"></span></p>
                <p><strong>Start Date:</strong> <span id="startDate"></span></p>
                <p><strong>Due Date:</strong> <span id="dueDate"></span></p>
                <p><strong>Completed Date:</strong> <span id="completedDate"></span></p>

                <h5>Activities</h5>
                <ul id="activitiesList" class="list-group"></ul>
            </div>
        </div>
    </div>
</div>


<!-- JavaScript to handle task selection and update activities -->
<script>
    document.getElementById('taskSelect').addEventListener('change', function () {
        var selectedOption = this.options[this.selectedIndex];

        if (selectedOption.value) {
            // Show the task details section
            document.getElementById('taskDetails').style.display = 'block';

            // Update task details
            document.getElementById('taskName').textContent = selectedOption.getAttribute('data-task-name');
            document.getElementById('taskDescription').textContent = selectedOption.getAttribute('data-task-description');
            document.getElementById('taskState').textContent = selectedOption.getAttribute('data-task-state');
            document.getElementById('startDate').textContent = selectedOption.getAttribute('data-start-date');
            document.getElementById('dueDate').textContent = selectedOption.getAttribute('data-due-date');
            document.getElementById('completedDate').textContent = selectedOption.getAttribute('data-completed-date');

            
            // Retrieve the JSON from the hidden script tag
            var activitiesScript = document.getElementById('task-activities-' + selectedOption.value);
            var activities = JSON.parse(activitiesScript.textContent);
            var activitiesList = document.getElementById('activitiesList');
            activitiesList.innerHTML = ''; // Clear previous activities

            activities.forEach(function(activity) {
                var listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = activity.ActivityNote + ' - ' + activity.CreatedDate;
                activitiesList.appendChild(listItem);
            });
        } else {
            // Hide the task details if no task is selected
            document.getElementById('taskDetails').style.display = 'none';
        }
    });
</script>
